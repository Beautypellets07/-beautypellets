<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Europa Preiskarte â€“ Pellets / Streusalz</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{height:100%;margin:0}
#map{height:100%;width:100%}

.box{
  position:absolute;background:#fff;padding:8px 10px;border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.12);
  font:14px/1.3 system-ui,Arial;z-index:2000
}
.search{top:12px;right:12px;width:260px}
.legend{bottom:12px;right:12px;min-width:180px}
.cert{bottom:12px;left:12px}

.box input[type="checkbox"]{width:14px;height:14px;margin-right:5px}
.search input,.search select{
  width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px
}
.hidden{display:none!important}
</style>
</head>

<body>
<div id="map"></div>

<!-- SUCHEN / FILTER -->
<div class="box search">
  ğŸ” <input id="searchInput" placeholder="Firma, Kunde oder Ort suchenâ€¦">

  <b style="display:block;margin-top:8px">Land / LÃ¤nder</b>
  <select id="countrySelect">
    <option value="all">Alle LÃ¤nder</option>
    <option value="de">Deutschland</option>
    <option value="pl">Polen</option>
    <option value="at">Ã–sterreich</option>
    <option value="ch">Schweiz</option>
  </select>

  <b style="display:block;margin-top:8px">Unit</b>
  <select id="unitSelect">
    <option value="pellets">Pellets</option>
    <option value="streusalz">Streusalz</option>
  </select>
</div>

<!-- ZERTIFIKATE -->
<div class="box cert" id="certBox">
  <b>Zertifikate</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
</div>

<!-- LEGEND / KUNDEN -->
<div class="box legend">

  <b>Filter Farben</b><br>
  <label><input type="checkbox" checked> ğŸŸ¢ â‰¤ 260 â‚¬</label><br>
  <label><input type="checkbox" checked> ğŸŸ  260â€“285 â‚¬</label><br>
  <label><input type="checkbox" checked> ğŸ”´ â‰¥ 285 â‚¬</label><br>
  <label><input type="checkbox" checked> âšª kein Preis</label><br>

  <!-- PELLETS -->
  <div id="kundenPellets">
    <hr>
    <label><input type="checkbox" checked> ğŸ”· PellethÃ¤ndler</label><br>
    <label><input type="checkbox" checked> ğŸŸ£ Sackwaren HÃ¤ndler</label><br>
    <label><input type="checkbox" checked> ğŸ”¶ Sonstige Kunden</label>
  </div>

  <!-- STREUSALZ -->
  <div id="kundenStreusalz" class="hidden">
    <hr>
    <label><input type="checkbox" id="chkStreusalzKunden" checked> ğŸ‘¤ Kunden</label>
  </div>

</div>

<script>
/* ===== KONFIG ===== */
const sheetIdFirmen = "1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk";
const sheetIdKunden = "1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I";

const URL_FIRMEN_PELLETS =
  `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/export?format=csv&gid=0`;
const URL_FIRMEN_STREUSALZ =
  `https://docs.google.com/spreadsheets/d/${sheetIdFirmen}/gviz/tq?tqx=out:csv&sheet=streusalz`;

const URL_KUNDEN_PELLETS =
  `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/export?format=csv&gid=0`;
const URL_KUNDEN_STREUSALZ =
  `https://docs.google.com/spreadsheets/d/${sheetIdKunden}/gviz/tq?tqx=out:csv&sheet=streusalz`;

/* ===== MAP ===== */
const map=L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ===== STATE ===== */
let currentUnit="pellets";
let werke=[], kunden=[], markers=[];

/* ===== UI ===== */
const unitSelect=document.getElementById("unitSelect");
const pelletsBox=document.getElementById("kundenPellets");
const streuBox=document.getElementById("kundenStreusalz");

function applyUnitUI(){
  if(currentUnit==="pellets"){
    pelletsBox.classList.remove("hidden");
    streuBox.classList.add("hidden");
  }else{
    pelletsBox.classList.add("hidden");
    streuBox.classList.remove("hidden");
  }
}

/* ===== LOADER ===== */
function loadCSV(url, header){
  return new Promise(res=>{
    Papa.parse(url,{
      download:true,header,
      complete:r=>res(r.data||[])
    });
  });
}

async function loadData(){
  const fUrl=currentUnit==="pellets"?URL_FIRMEN_PELLETS:URL_FIRMEN_STREUSALZ;
  const kUrl=currentUnit==="pellets"?URL_KUNDEN_PELLETS:URL_KUNDEN_STREUSALZ;

  werke = await loadCSV(fUrl,false);
  kunden = await loadCSV(kUrl,true);
}

/* ===== BUILD MAP ===== */
async function buildMap(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  for(const r of werke.slice(1)){
    const ort=r[1];
    if(!ort) continue;

    const g=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ort)}`).then(r=>r.json());
    if(!g[0]) continue;

    const m=L.circleMarker([g[0].lat,g[0].lon],{
      radius:8,color:"green",fillColor:"green",fillOpacity:.8
    }).addTo(map).bindTooltip(`<b>${r[0]}</b><br>${ort}`);

    markers.push(m);
  }

  for(const k of kunden){
    if(!k.name||!k.ort) continue;

    const g=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(k.ort)}`).then(r=>r.json());
    if(!g[0]) continue;

    const m=L.marker([g[0].lat,g[0].lon])
      .addTo(map)
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`);

    markers.push(m);
  }
}

/* ===== UNIT SWITCH ===== */
unitSelect.addEventListener("change",async()=>{
  currentUnit=unitSelect.value;
  applyUnitUI();
  await loadData();
  await buildMap();
});

/* ===== INIT ===== */
(async()=>{
  applyUnitUI();
  await loadData();
  await buildMap();
})();
</script>
</body>
</html>
