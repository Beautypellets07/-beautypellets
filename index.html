<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pellets ‚Äì √úbungskarte</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body,#map{height:100%;margin:0}
.box{position:absolute;background:#fff;padding:8px 10px;border-radius:6px;
box-shadow:0 2px 8px rgba(0,0,0,.15);font:14px system-ui}
.search{top:10px;right:10px;width:250px}
</style>
</head>

<body>
<div id="map"></div>

<div class="box search">
üîç <input id="search" placeholder="Firma, Kunde oder Ort" style="width:100%">
</div>

<script>
/* ================= CSV LINKS ================= */
const sheetFirmen =
"https://docs.google.com/spreadsheets/d/1fNUc0LJqBXxJdW1JRDfYxYORMuqeks_bHqp7zUq5Zmk/export?format=csv&gid=0";

const sheetKunden =
"https://docs.google.com/spreadsheets/d/1fK_rO1b2eI4sOvUKOufVgmd2lQ85KazPf5Kfm4Iia5I/export?format=csv&gid=0";

/* ================= MAP ================= */
const map=L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
{attribution:"¬© OpenStreetMap"}).addTo(map);

const geoCache=JSON.parse(localStorage.getItem("geoPellet")||"{}");
const saveGeo=()=>localStorage.setItem("geoPellet",JSON.stringify(geoCache));

async function geocode(q){
 if(geoCache[q]) return geoCache[q];
 const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
 const d=await r.json(); if(!d.length) return null;
 geoCache[q]={lat:+d[0].lat,lon:+d[0].lon}; saveGeo();
 return geoCache[q];
}

const tri=c=>L.divIcon({html:`<svg width="24" height="24">
<polygon points="12,2 22,22 2,22" fill="${c}" stroke="black"/></svg>`,
iconAnchor:[12,22]});

const iconBlue=tri("blue"), iconPurple=tri("purple"), iconOrange=tri("orange");

let werke=[], kunden=[], marker=[], selected=[], routeLine=null;

/* ================= LADEN ================= */
Papa.parse(sheetFirmen,{
 download:true,header:true,
 complete:r=>{
  werke=r.data.map(x=>({
   firma:x.firma, ort:x.ort,
   preis:+String(x.preis).replace(",","."),
   sackpreis:+String(x.sackwarenpreis).replace(",",".")
  })).filter(x=>x.firma&&x.ort);
  Papa.parse(sheetKunden,{
   download:true,header:true,
   complete:r2=>{
    kunden=r2.data.map(x=>({
     name:x.name, ort:x.ort,
     lose:x.lose, sack:x.sackware, sonstige:x.sonstige
    })).filter(x=>x.name&&x.ort);
    build();
   }
  });
 }
});

/* ================= BUILD MAP ================= */
async function build(){
 for(const w of werke){
  const g=await geocode(w.ort); if(!g)continue;
  const m=L.circleMarker([g.lat,g.lon],{radius:7,color:"green"})
   .bindTooltip(`<b>${w.firma}</b><br>${w.ort}`)
   .on("click",()=>pick(w.firma,g));
  m.addTo(map); marker.push(m);
 }

 for(const k of kunden){
  const g=await geocode(k.ort); if(!g)continue;
  let icon=iconBlue;
  if(k.sonstige==="ja") icon=iconOrange;
  else if(k.sack==="ja" && k.lose!=="ja") icon=iconPurple;

  const m=L.marker([g.lat,g.lon],{icon})
   .bindTooltip(`<b>${k.name}</b><br>${k.ort}`)
   .on("click",()=>pick(k.name,g));
  m.addTo(map); marker.push(m);
 }
}

/* ================= ROUTE ================= */
function distKm(a,b){
 const R=6371,toRad=x=>x*Math.PI/180;
 const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);
 const h=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
 return 2*R*Math.asin(Math.sqrt(h));
}

function pick(label,coord){
 selected.push({label,coord});
 if(selected.length===2){
  const [a,b]=selected; selected=[];
  showRoute(a,b);
 }
}

function showRoute(a,b){
 const km=distKm(a.coord,b.coord);
 const preisKm=km<250?2.15:1.85;
 const firma=werke.find(w=>w.firma===a.label||w.firma===b.label);
 const ek=firma?firma.preis:0;
 const gesamt=((km/24*preisKm)+ek)*1.05;

 if(routeLine)map.removeLayer(routeLine);
 routeLine=L.polyline([[a.coord.lat,a.coord.lon],[b.coord.lat,b.coord.lon]],
 {color:"blue",dashArray:"6 6"}).addTo(map);

 L.popup().setLatLng([(a.coord.lat+b.coord.lat)/2,(a.coord.lon+b.coord.lon)/2])
 .setContent(`
 <b>${a.label} ‚Üî ${b.label}</b><br>
 Entfernung: ${km.toFixed(1)} km<br>
 Gesamtkosten: <b style="color:green">${gesamt.toFixed(2)} ‚Ç¨</b>
 `).openOn(map);
}

/* ================= SUCHE ================= */
search.onkeydown=e=>{
 if(e.key!=="Enter")return;
 const q=e.target.value.toLowerCase();
 marker.forEach(m=>{
  const t=m.getTooltip()?.getContent().toLowerCase()||"";
  if(t.includes(q)) m.openTooltip();
 });
};
</script>
</body>
</html>
